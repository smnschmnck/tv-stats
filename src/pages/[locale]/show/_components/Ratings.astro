---
import { type Ratings } from "../../../../db/redis";
import { getIsDividedByYears } from "../_utils/seasonMapper";
import Season from "./Season.astro";

interface Props {
  ratings: Ratings | undefined;
}

const { ratings } = Astro.props;

const { t } = Astro.locals;

const isDividedByYears = getIsDividedByYears(ratings);

const getSeasons = async () => {
  try {
    const eps = ratings?.episodes ?? [];

    const seasonsMap = Map.groupBy(eps, (episode) =>
      isDividedByYears ? Number(episode.startYear ?? 0) : episode.seasonNumber,
    );
    const seasons = Array.from(seasonsMap.entries());
    const sortedSeasons = seasons.toSorted(([a], [b]) => {
      if (!(a && b)) {
        return 0;
      }
      return a - b;
    });

    const sortedSeasonsAndEpisodes = sortedSeasons.map(
      ([seasonNumber, episodes]) => {
        const sortedEpisodes = episodes.toSorted((a, b) => {
          if (!(a.episodeNumber && b.episodeNumber)) {
            return 0;
          }
          return a.episodeNumber - b.episodeNumber;
        });
        return [seasonNumber, sortedEpisodes] as const;
      },
    );

    return { seasons: sortedSeasonsAndEpisodes, error: undefined };
  } catch (e) {
    return { seasons: undefined, error: t("common.somethingWentWrong") };
  }
};

const { seasons, error } = await getSeasons();
---

{!!error && <p>{error}</p>}

{
  !error && seasons && (
    <div class="flex w-full gap-4 overflow-x-auto">
      {seasons.map(([seasonNumber, episodes]) =>
        seasonNumber ? (
          <Season seasonNumber={seasonNumber} episodes={episodes} />
        ) : null,
      )}
    </div>
  )
}
