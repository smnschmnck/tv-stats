---
import { ArrowDown, ArrowUp } from "@lucide/astro";
import { asc, desc, eq } from "drizzle-orm";
import { db } from "../../../../db/drizzle";
import { episodes, ratings } from "../../../../db/schema";
import Rating from "./Rating.astro";
import EpisodeRankingsBase from "./EpisodeRankingsBase.astro";

interface Props {
  imdbId: string | undefined;
}

const { imdbId } = Astro.props;

const getHighestRatings = () => {
  if (!imdbId) {
    return;
  }

  return db
    .select({
      tconst: ratings.tconst,
      averageRating: ratings.averageRating,
      season: episodes.seasonNumber,
      episode: episodes.episodeNumber,
    })
    .from(episodes)
    .innerJoin(ratings, eq(episodes.tconst, ratings.tconst))
    .where(eq(episodes.parentTconst, imdbId))
    .orderBy(desc(ratings.averageRating))
    .limit(3);
};

const highestRankings = await getHighestRatings();

const getLowestRatings = () => {
  if (!imdbId) {
    return;
  }

  return db
    .select({
      tconst: ratings.tconst,
      averageRating: ratings.averageRating,
      season: episodes.seasonNumber,
      episode: episodes.episodeNumber,
    })
    .from(episodes)
    .innerJoin(ratings, eq(episodes.tconst, ratings.tconst))
    .where(eq(episodes.parentTconst, imdbId))
    .orderBy(asc(ratings.averageRating))
    .limit(3);
};

const lowestRankings = await getLowestRatings();
---

<EpisodeRankingsBase
  highestRatings={highestRankings}
  lowestRatings={lowestRankings}
/>
